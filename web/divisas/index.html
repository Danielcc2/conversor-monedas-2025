<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Conversor de Divisas</title>
    <style>
      :root {
        --bg: #0f172a;
        --panel: #111827;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --primary: #10b981;
        --danger: #ef4444;
      }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); margin: 0; }
      .container { position: relative; max-width: 760px; margin: 40px auto; padding: 24px; background: var(--panel); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.3); }
      .topbar { position: sticky; top: 0; display:flex; justify-content:flex-end; align-items:center; margin-bottom: 8px; gap: 8px; z-index: 50; }
      .user { position: relative; }
      .user-btn { background:linear-gradient(135deg,#0b1220,#0e162b); border:1px solid #1f2937; color:var(--text); padding:8px 12px; border-radius:999px; cursor:pointer; box-shadow:0 6px 16px rgba(0,0,0,.25); }
      .dropdown { position:absolute; right:0; top:calc(100% + 8px); background:#0b1220; border:1px solid #1f2937; border-radius:12px; min-width:220px; box-shadow:0 18px 40px rgba(0,0,0,.45); display:none; overflow:hidden; z-index: 1000; }
      .dropdown.open { display:block; }
      .dropdown .dd-header { padding:10px 12px; font-size:.85rem; color:var(--muted); border-bottom:1px solid #1f2937; }
      .dropdown a { display:block; padding:10px 12px; color:var(--text); text-decoration:none; }
      .dropdown a:hover { background:#111827; }
      h1 { margin: 0 0 12px; font-size: 1.6rem; text-align: center; }
      p.sub { margin: 0 0 20px; color: var(--muted); }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
      label { font-size: .9rem; color: var(--muted); display: block; margin-bottom: 6px; }
      input, select, button { width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid #1f2937; background: #0b1220; color: var(--text); }
      input:focus, select:focus, button:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,.25); }
      button { transition: transform .04s ease, filter .15s ease; }
      button.primary { background: var(--primary); color: #052e2b; border: none; font-weight: 600; cursor: pointer; }
      button.primary:disabled { opacity: .6; cursor: not-allowed; }
      button:hover { filter: brightness(1.08); }
      button:active { transform: translateY(1px); }
      .actions { display: flex; gap: 12px; margin-top: 16px; }
      .muted { color: var(--muted); font-size: .9rem; }
      .result { margin-top: 16px; font-size: 1.2rem; font-weight: 600; text-align: center; }
      .warn { color: var(--danger); }
      footer { margin-top: 20px; font-size: .85rem; color: var(--muted); }
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .badge { position: fixed; bottom: 12px; right: 12px; font-size: 12px; color: #9ca3af; background: rgba(17,24,39,.75); padding:6px 10px; border:1px solid #1f2937; border-radius: 999px; z-index: 60; }
      /* (El panel de secciones se ha retirado a petición del usuario) */
      /* Estilo elegante para el input de monto */
      .input-wrap { position: relative; border-radius: 12px; padding: 1px; background: linear-gradient(135deg, #1f2937, #334155); }
      .input-wrap > input { border: none; background: #0b1220; border-radius: 11px; width: 100%; padding: 14px 14px 14px 56px; }
      .input-wrap > input::placeholder { color: #6b7280; }
      .input-wrap .prefix { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); min-width: 30px; text-align: center; color: #a3e635; font-weight: 700; letter-spacing: .5px; }
      /* Quitar spinners en algunos navegadores para un look más limpio */
      input[type=number]::-webkit-outer-spin-button,
      input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
      input[type=number] { -moz-appearance: textfield; }
      /* Select estilizado */
      .select { position: relative; }
      .select select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background: #0b1220;
        padding-right: 42px; /* espacio para el ícono */
        border-radius: 10px;
      }
      .select::after {
        content: "";
        position: absolute;
        pointer-events: none;
        right: 12px;
        top: 50%;
        width: 18px;
        height: 18px;
        transform: translateY(-50%);
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23e5e7eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>');
        opacity: .85;
      }
      @media (max-width: 640px) { .row, .row3, .grid { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <header style="position:sticky;top:0;z-index:60;background:transparent;padding:12px 16px">
      <div style="display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:18px">
        <nav style="display:flex;gap:18px;align-items:center;font-weight:700">
          <a href="/blog" style="color:#e5e7eb;text-decoration:none">Blog</a>
          <a href="/destinos" style="color:#e5e7eb;text-decoration:none">Destinos</a>
        </nav>
        <a href="/" style="justify-self:center"><img src="/assets/logo.svg" alt="Dael‑viajes" style="width:64px;height:64px"></a>
        <div style="display:flex;gap:18px;align-items:center;justify-content:flex-end">
          <a href="/presupuestos" style="color:#e5e7eb;text-decoration:none;font-weight:700">Presupuestos</a>
          <a href="/consejos" style="color:#e5e7eb;text-decoration:none;font-weight:700">Consejos</a>
          <a href="/diario" style="color:#e5e7eb;text-decoration:none;font-weight:700">Diario</a>
          <div class="user"><button id="userBtn" class="user-btn"><span id="userName">—</span> ▾</button>
            <div id="userDropdown" class="dropdown"><div class="dd-header">Dael‑viajes</div><a href="/">Inicio</a><a href="#" id="menuLogout">Cerrar sesión</a></div>
          </div>
        </div>
      </div>
    </header>
    <div class="container" style="margin-top:12px">
      <div class="topbar">
        <div class="user">
          <button id="userBtn" class="user-btn"><span id="userName">—</span> ▾</button>
          <div id="userDropdown" class="dropdown">
            <div class="dd-header">Tu espacio</div>
            <a href="#" id="menuProfile">Perfil</a>
            <a href="#" id="menuPrefs">Preferencias</a>
            <a href="#" id="menuHistory">Historial</a>
            <hr style="border:0;border-top:1px solid #1f2937;margin:6px 0;">
            <a href="#" id="menuLogout">Cerrar sesión</a>
          </div>
        </div>
      </div>
      <h1>Conversor de Divisas</h1>
      <div id="updatedBadge" class="badge" style="display:none">divisas actualizadas</div>

      <div class="row3">
        <div>
          <label for="amount">Cantidad</label>
          <div class="input-wrap amount">
            <span class="prefix" id="currencySymbol">$</span>
            <input id="amount" type="number" step="0.01" min="0" placeholder="0.00" value="100" />
          </div>
        </div>
        <div>
          <label for="from">Desde</label>
          <div class="select">
            <select id="from">
              <option value="USD" selected>USD</option>
              <option value="EUR">EUR</option>
              <option value="MXN">MXN</option>
              <option value="ARS">ARS</option>
              <option value="COP">COP</option>
              <option value="CLP">CLP</option>
              <option value="PEN">PEN</option>
              <option value="GBP">GBP</option>
              <option value="JPY">JPY</option>
              <option value="BRL">BRL</option>
              <option value="CAD">CAD</option>
            </select>
          </div>
        </div>
        <div>
          <label for="to">Hacia</label>
          <div class="select">
            <select id="to">
              <option value="USD">USD</option>
              <option value="EUR" selected>EUR</option>
              <option value="MXN">MXN</option>
              <option value="ARS">ARS</option>
              <option value="COP">COP</option>
              <option value="CLP">CLP</option>
              <option value="PEN">PEN</option>
              <option value="GBP">GBP</option>
              <option value="JPY">JPY</option>
              <option value="BRL">BRL</option>
              <option value="CAD">CAD</option>
            </select>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="convert" class="primary">Convertir</button>
        <button id="swap">Intercambiar</button>
      </div>

      <div class="result" id="output">—</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      const SUPABASE_URL = 'https://ubqsbofiyhearumlmdif.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVicXNib2ZpeWhlYXJ1bWxtZGlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MjczNzUsImV4cCI6MjA3MzEwMzM3NX0.CpXG7JL7sOb1Rdn0BMyqN9MxsV13UMpSwazuhQt8jlE';
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      window.sb = supabase; // Exponer cliente para depuración
      const SUPPORTED = [
        "USD","EUR","MXN","ARS","COP","CLP","PEN","GBP","JPY","BRL","CAD"
      ];
      const SYMBOLS = {
        USD: '$', EUR: '€', MXN: 'MX$', ARS: 'AR$', COP: 'COP$', CLP: 'CLP$', PEN: 'S/', GBP: '£', JPY: '¥', BRL: 'R$', CAD: 'C$'
      };
      const DEFAULTS = {
        USD: 1,
        EUR: 0.92,
        MXN: 19.8,
        ARS: 980,
        COP: 3940,
        CLP: 910,
        PEN: 3.75,
        GBP: 0.78,
        JPY: 146.5,
        BRL: 5.1,
        CAD: 1.36,
      };

      const $ = (id) => document.getElementById(id);
      const todayStr = () => new Date().toISOString().slice(0,10);
      const CACHE_KEY = 'ratesCacheV1';
      let IN_MEMORY_RATES = null;

      function loadCache(){
        try {
          const raw = localStorage.getItem(CACHE_KEY);
          if(!raw) return null;
          return JSON.parse(raw);
        } catch { return null; }
      }

      function saveCache(obj){
        try { localStorage.setItem(CACHE_KEY, JSON.stringify(obj)); } catch {}
      }

      function getRatesFromCache(){
        const cache = loadCache();
        if(cache && cache.rates){ return cache; }
        return null;
      }

      function currentRates(){
        if (IN_MEMORY_RATES) return { ...IN_MEMORY_RATES };
        const c = getRatesFromCache();
        if(!c) return {...DEFAULTS};
        const out = {...DEFAULTS};
        for(const k of Object.keys(c.rates)){
          if(SUPPORTED.includes(k)) out[k] = Number(c.rates[k]);
        }
        return out;
      }

      async function fetchRates(){
        const url = 'https://api.exchangerate.host/latest?base=USD';
        const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if(!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();
        if(!data || !data.rates) throw new Error('Respuesta inválida');
        const out = { USD: 1 };
        for(const k of SUPPORTED){
          if(typeof data.rates[k] === 'number') out[k] = data.rates[k];
        }
        return out;
      }

  async function fetchServerRates(){
    try {
      const resp = await fetch('/rates.json?v=' + Date.now(), { cache: 'no-store' });
      if(!resp.ok) return null;
      const data = await resp.json();
      if(!data || !data.rates) return null;
      const out = { ...DEFAULTS };
      for(const k of SUPPORTED){
        if(typeof data.rates[k] === 'number') out[k] = data.rates[k];
      }
      IN_MEMORY_RATES = out;
      saveCache({ last_updated: data.last_updated, day: todayStr(), fetch_count: 2, rates: out });
      const badge = document.getElementById('updatedBadge');
      if (badge){
        badge.style.display = 'block';
      }
      return out;
    } catch (e) {
      console.warn('No server rates.json yet', e);
      return null;
    }
  }

  async function getUser(){
    const { data } = await supabase.auth.getUser();
    return data?.user || null;
  }

  function displayUserName(user){
    const name = user?.user_metadata?.name || (user?.email ? user.email.split('@')[0] : '');
    const el = document.getElementById('userName');
    if (el) el.textContent = name || 'Usuario';
  }

  async function requireAuth(){
    const user = await getUser();
    if(!user){
      window.location.href = '/';
      return null;
    }
    displayUserName(user);
    return user;
  }

  /* Se elimina buildRightPanel y su UI asociada */

  async function loadPreferences(){
    const user = await getUser();
    if(!user) return; // invitado: no carga preferencias del servidor
    try {
      const { data, error } = await supabase
        .from('preferences')
        .select('default_from, default_to')
        .eq('user_id', user.id)
        .maybeSingle();
      if (data){
        if (SUPPORTED.includes(data.default_from)) $('from').value = data.default_from;
        if (SUPPORTED.includes(data.default_to)) $('to').value = data.default_to;
        updateCurrencySymbol();
      } else {
        // Semilla automática en el primer login
        const seedFrom = SUPPORTED.includes(($('from').value||'')) ? $('from').value : 'USD';
        const seedTo = SUPPORTED.includes(($('to').value||'')) ? $('to').value : 'EUR';
        await supabase.from('preferences').upsert({
          user_id: user.id,
          default_from: seedFrom,
          default_to: seedTo,
          updated_at: new Date().toISOString()
        }, { onConflict: 'user_id' });
      }
    } catch(e){ /* noop */ }
  }

  async function savePreferences(){
    const user = await getUser();
    if(!user) return; // invitado: no guarda
    const payload = {
      user_id: user.id,
      default_from: $('from').value,
      default_to: $('to').value,
      updated_at: new Date().toISOString()
    };
    try {
      await supabase.from('preferences').upsert(payload, { onConflict: 'user_id' });
    } catch(e){ /* noop */ }
  }

      function updateCurrencySymbol(){
        const from = $('from').value;
        $('currencySymbol').textContent = SYMBOLS[from] || '';
      }

      function convert(){
        const amount = Number(($('amount').value || '').replace(',', '.'));
        if(!(amount >= 0)) { $('output').textContent = 'Monto inválido'; return; }
        const from = $('from').value;
        const to = $('to').value;
        if(!SUPPORTED.includes(from) || !SUPPORTED.includes(to)) return;
        const rates = currentRates();
        const usd = amount / Number(rates[from]);
        const res = usd * Number(rates[to]);
        $('output').textContent = `${amount.toFixed(2)} ${from} = ${res.toFixed(2)} ${to}`;
      }

      function swap(){
        const a = $('from').value; const b = $('to').value;
        $('from').value = b; $('to').value = a;
        updateCurrencySymbol();
        convert();
        savePreferences();
      }

      async function init(){
        const user = await requireAuth();
        if(!user) return;
        await fetchServerRates();
        await loadPreferences();
        convert();
        $('convert').addEventListener('click', convert);
        $('swap').addEventListener('click', swap);
        $('amount').addEventListener('input', convert);
        $('from').addEventListener('change', () => { updateCurrencySymbol(); convert(); savePreferences(); });
        $('to').addEventListener('change', () => { convert(); savePreferences(); });
        updateCurrencySymbol();

        // User menu
        const btn = document.getElementById('userBtn');
        const dd = document.getElementById('userDropdown');
        btn?.addEventListener('click', (e)=>{ e.preventDefault(); dd?.classList.toggle('open'); });
        document.addEventListener('click', (e)=>{ if(!dd) return; if(!dd.contains(e.target) && !btn.contains(e.target)) dd.classList.remove('open'); });
        document.getElementById('menuLogout')?.addEventListener('click', async (e)=>{ e.preventDefault(); await supabase.auth.signOut(); window.location.href = '/'; });
        document.getElementById('menuPrefs')?.addEventListener('click', (e)=>{ e.preventDefault(); dd?.classList.remove('open'); document.getElementById('from')?.focus(); });
        document.getElementById('menuProfile')?.addEventListener('click', (e)=>{ e.preventDefault(); alert('Perfil: próximamente.'); });
        document.getElementById('menuHistory')?.addEventListener('click', (e)=>{ e.preventDefault(); alert('Historial: próximamente.'); });
        document.getElementById('menuLogout')?.addEventListener('click', async (e)=>{ e.preventDefault(); await supabase.auth.signOut(); window.location.href = '/'; });

        // (Sin panel de categorías en esta vista)
      }

      init();
    </script>
  </body>
  </html>
